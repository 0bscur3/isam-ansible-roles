---
# task file for ISAM appliance first steps
#
#     accept service agreements
#     set up LMI FIPS
#     restart LMI
#     change password
#
# accept service agreements
- name: accept service agreements
  isam:
    appliance: "{{inventory_hostname}}"
    username: admin
    password: admin
    action: ibmsecurity.isam.base.service_agreement.set

- name: last boot
  isam:
    appliance: "{{inventory_hostname}}"
    username: admin
    password: admin
    action: ibmsecurity.isam.base.firmware.get
  register: ret_obj

- set_fact:
    last_boot: "{{ret_obj.data[0].last_boot}}"

# set up LMI FIPS
- name: set up FIPS
  isam:
    appliance: "{{inventory_hostname}}"
    username: admin
    password: admin
    action: ibmsecurity.isam.base.fips.set
    isamapi:
      fipsEnabled: "{{FIPS_cfg.fipsEnabled}}"
      tlsv10Enabled: "{{FIPS_cfg.tlsv10Enabled}}"
      tlsv11Enabled: "{{FIPS_cfg.tlsv11Enabled}}"
  register: ret_obj
- debug: var=ret_obj

# Restart after FIPS if needed
- name: FIPS_Restart
  isam:
      appliance: "{{inventory_hostname}}"
      username: admin
      password: admin
      action: ibmsecurity.isam.base.fips.restart
  when: ret_obj.data.reboot is defined and ret_obj.data.reboot == true

- name: pause
  pause:
    minutes: "{{fips_restart_wait_time}}"
  when: ret_obj.data.reboot is defined and ret_obj.data.reboot == true

# Make sure system restarted
- name: check FIPS settings
  isam:
    appliance: "{{inventory_hostname}}"
    username: admin
    password: admin
    action: ibmsecurity.isam.base.firmware.get
  register: result
  retries: 5
  delay: 30
  ignore_errors: true
  until: result.rc == 0 and (result.data[0].last_boot != last_boot)
  when: ret_obj.data.reboot is defined and ret_obj.data.reboot == true

# Complete the appliance set up
- name: complete appliance set up
  isam:
    appliance: "{{inventory_hostname}}"
    username: admin
    password: admin
    action: ibmsecurity.isam.base.setup_complete.set
  register: ret_obj
- debug: var=ret_obj

# Change password
- name: change password
  isam: 
      appliance: "{{inventory_hostname}}"
      password: "admin"
      action: ibmsecurity.isam.base.admin.set_pw
      isamapi:
          'oldPassword': 'admin'
          'newPassword': "{{password}}"
          'sessionTimeout': "{{lmi_session_timeout}}"

- name: check timestamp before restart
  isam:
    appliance: "{{ inventory_hostname }}"
    username:  "{{ username }}"
    password:  "{{ password }}"
    lmi_port:  "{{ lmi_port }}"
    log:       "{{ log_level }}"
    force:     "{{ force }}"
    action: ibmsecurity.isam.base.lmi.get
  register: ret_obj

- set_fact:
    old_start_time: "{{ret_obj.data[0].start_time}}"

- name: commit changes
  isam:
    appliance: "{{ inventory_hostname }}"
    username:  "{{ username }}"
    password:  "{{ password }}"
    lmi_port:  "{{ lmi_port }}"
    log:       "{{ log_level }}"
    force:     "{{ force }}"
    action: ibmsecurity.isam.appliance.commit_and_restart

- name: wait for 1 minute
  pause:
      minutes: 1

- name: wait for LMI up
  isam:
      appliance: "{{inventory_hostname}}"
      username: "{{username}}"
      password: "{{password}}"
      action: ibmsecurity.isam.base.lmi.await_startup
      isamapi:
          start_time: "{{old_start_time}}"
          wait_time: "{{start_config_wait_time}}"
  retries: 5
  delay: 30
  ignore_errors: true

